apiVersion: v1
kind: ConfigMap
metadata:
    name: mosquitto-config
data:
  mosquitto.conf: |-
    persistence true
    persistence_location /mosquitto/data/
    log_dest stdout
    log_type all
    
    listener 1883
    allow_anonymous true
    protocol mqtt

    listener 8883
    tls_version tlsv1.2
    protocol mqtt
    allow_anonymous true
    cafile /mosquitto/config/certs/ca.crt
    certfile /mosquitto/config/certs/server.crt
    keyfile /mosquitto/config/certs/server.key
    require_certificate false
    use_subject_as_username true

    {{- if .Values.bridge }}
    
    connection {{ .Values.bridge.connectionName }}
    address {{ .Values.bridge.address }}:8883
    bridge_cafile /mosquitto/config/bridge/bridgeca.crt
    # bridge_certfile /mosquitto/config/bridge/bridgeclient.crt
    # bridge_keyfile /mosquitto/config/bridge/bridgeclient.key
    topic telemetry/# out
    # allow for self-signed certs, skip cert chain & hostname validation
    bridge_insecure true

    cleansession false
    notifications false

    remote_clientid {{ .Values.bridge.connectionName }}

    start_type automatic
    # try_private true
    {{- end }}